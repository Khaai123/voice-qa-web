<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Q&A Recorder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f4f4f4;
    }
    .question-block {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .question-text {
      font-size: 1.1em;
      margin-bottom: 10px;
      padding: 6px;
      border: 1px dashed transparent;
    }
    .question-text[contenteditable="true"]:focus {
      border: 1px dashed #888;
      background-color: #f0f8ff;
      outline: none;
    }
    button {
      padding: 8px 16px;
      margin: 5px 5px 5px 0;
      cursor: pointer;
    }
    .answer {
      margin-top: 10px;
      padding: 10px;
      background: #e9ecef;
      border-radius: 5px;
      min-height: 30px;
    }
  </style>
</head>
<body>

  <h1>Q&A Voice Recorder (English)</h1>

  <div id="questions-container">
    <!-- Initial Questions -->
    <div class="question-block" data-index="0">
      <div class="question-text" contenteditable="true">1. What is your name?</div>
      <button onclick="speakQuestion(0)">üîà Read</button>
      <button onclick="startRecognition(0)">üé§ Start Recording</button>
      <button onclick="stopRecognition()">üõë Stop</button>
      <button onclick="playAudio(0)">‚ñ∂Ô∏è Play</button>
      <div class="answer" id="answer-0">Your answer will appear here...</div>
      <audio id="audio-0" controls style="display: none;"></audio>
    </div>

    <div class="question-block" data-index="1">
      <div class="question-text" contenteditable="true">2. What did you do yesterday?</div>
      <button onclick="speakQuestion(1)">üîà Read</button>
      <button onclick="startRecognition(1)">üé§ Start Recording</button>
      <button onclick="stopRecognition()">üõë Stop</button>
      <button onclick="playAudio(1)">‚ñ∂Ô∏è Play</button>
      <div class="answer" id="answer-1">Your answer will appear here...</div>
      <audio id="audio-1" controls style="display: none;"></audio>
    </div>
  </div>

  <button onclick="addNewQuestion()">‚ûï Th√™m c√¢u h·ªèi m·ªõi</button>

  <script>
    let recognition;
    let currentAnswerIndex = null;
    let questionCount = 2; // B·∫Øt ƒë·∫ßu t·ª´ c√¢u th·ª© 2

    if (!('webkitSpeechRecognition' in window)) {
      alert('Speech recognition not supported in this browser.');
    } else {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = function(event) {
  let transcript = '';
  for (let i = event.resultIndex; i < event.results.length; ++i) {
    if (event.results[i].isFinal) {
      transcript += event.results[i][0].transcript;
    }
  }
  if (currentAnswerIndex !== null && transcript) {
    const answerBox = document.getElementById(`answer-${currentAnswerIndex}`);
    answerBox.textContent = transcript; // <-- thay v√¨ +=
  }
};
      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
      };
    }

    function startRecognition(index) {
      currentAnswerIndex = index;
      if (recognition) recognition.start();
      startAudioRecording(index);
    }

    function stopRecognition() {
      if (recognition) recognition.stop();
      stopAudioRecording();
    }

    // === Audio Recording ===
    let mediaRecorder;
    let audioChunks = [];
    let currentAudioIndex = null;

    async function startAudioRecording(index) {
      currentAudioIndex = index;
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (e) => {
        audioChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioURL = URL.createObjectURL(blob);
        const audioElement = document.getElementById(`audio-${currentAudioIndex}`);
        audioElement.src = audioURL;
        audioElement.style.display = 'block';
      };

      mediaRecorder.start();
    }

    function stopAudioRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
    }

    function playAudio(index) {
      const audio = document.getElementById(`audio-${index}`);
      audio.play();
    }

    // === Text-to-Speech (gi·ªçng n·ªØ n·∫øu c√≥) ===
    let femaleVoice = null;

    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      femaleVoice = voices.find(v =>
        v.lang.startsWith("en") && (v.name.toLowerCase().includes("female") || v.name.toLowerCase().includes("woman") || v.name.toLowerCase().includes("samantha"))
      );
      if (!femaleVoice && voices.length > 0) {
        femaleVoice = voices.find(v => v.lang.startsWith("en"));
      }
    }

    speechSynthesis.onvoiceschanged = loadVoices;

    function speakQuestion(index) {
      const text = document.querySelector(`.question-block[data-index="${index}"] .question-text`).textContent;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = femaleVoice;
      utterance.lang = 'en-US';
      speechSynthesis.speak(utterance);
    }

    // === Th√™m c√¢u h·ªèi m·ªõi ===
    function addNewQuestion() {
      const container = document.getElementById('questions-container');

      const index = questionCount;
      const questionDiv = document.createElement('div');
      questionDiv.className = 'question-block';
      questionDiv.setAttribute('data-index', index);

      questionDiv.innerHTML = `
        <div class="question-text" contenteditable="true">${index + 1}. New question...</div>
        <button onclick="speakQuestion(${index})">üîà Read</button>
        <button onclick="startRecognition(${index})">üé§ Start Recording</button>
        <button onclick="stopRecognition()">üõë Stop</button>
        <button onclick="playAudio(${index})">‚ñ∂Ô∏è Play</button>
        <div class="answer" id="answer-${index}">Your answer will appear here...</div>
        <audio id="audio-${index}" controls style="display: none;"></audio>
      `;

      container.appendChild(questionDiv);
      questionCount++;
    }

    window.onload = loadVoices;
  </script>

</body>
<style>
  #gpt-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5);
    z-index: 9998;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #gpt-popup {
    background: white;
    width: 600px;
    max-width: 90%;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    font-family: Arial, sans-serif;
    z-index: 9999;
  }

  #gpt-popup h2 {
    margin-top: 0;
    font-size: 18px;
  }

  #gpt-popup textarea {
    width: 100%;
    height: 120px;
    margin-top: 10px;
    padding: 8px;
    font-size: 14px;
    border-radius: 6px;
    border: 1px solid #ccc;
    resize: vertical;
  }

  #gpt-popup button {
    margin-top: 15px;
    padding: 10px 16px;
    font-size: 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  #gpt-send {
    background-color: #10a37f;
    color: white;
    margin-right: 10px;
  }

  #gpt-close {
    background-color: #ccc;
    color: black;
  }
</style>

<script>
document.addEventListener("mouseup", function () {
  const selectedText = window.getSelection().toString().trim();
  if (selectedText.length > 0) {
    showOverlayWithGPTPrompt(selectedText);
  }
});

function showOverlayWithGPTPrompt(selectedText) {
  const prompt = "Ch·ªânh gi√∫p t√¥i ƒëo·∫°n vƒÉn sau, ch·ªânh s·ª≠a t·ª´ng c√¢u m·ªôt ch·ªâ ra ƒëi·ªÉm sai v√† s·ª≠a th·∫ø n√†o l√† h·ª£p l√Ω, v√† vi·∫øt th√™m nh·ªØng c√¢u ƒë·ªìng nghƒ©a ph√π h·ª£p v·ªõi vƒÉn n√≥i v√† vƒÉn vi·∫øt.";

  // Remove old popup if exists
  const oldOverlay = document.getElementById("gpt-overlay");
  if (oldOverlay) oldOverlay.remove();

  // Create overlay
  const overlay = document.createElement("div");
  overlay.id = "gpt-overlay";

  // Create popup
  const popup = document.createElement("div");
  popup.id = "gpt-popup";
  popup.innerHTML = `
    <h2>Y√™u c·∫ßu ChatGPT ch·ªânh s·ª≠a ƒëo·∫°n vƒÉn</h2>
    <div><strong>Prompt:</strong></div>
    <div style="background:#f4f4f4;padding:10px;border-radius:6px;margin-bottom:10px;font-size:14px;">${prompt}</div>
    <div><strong>ƒêo·∫°n vƒÉn b·∫°n ch·ªçn:</strong></div>
    <textarea>${selectedText}</textarea>
    <div style="margin-top:10px;">
      <button id="gpt-send">üöÄ M·ªü ChatGPT v·ªõi ƒëo·∫°n vƒÉn n√†y</button>
      <button id="gpt-close">ƒê√≥ng</button>
    </div>
  `;

  overlay.appendChild(popup);
  document.body.appendChild(overlay);

  // Button handlers
  document.getElementById("gpt-close").onclick = () => overlay.remove();

  document.getElementById("gpt-send").onclick = () => {
    const textArea = popup.querySelector("textarea");
    const message = `${prompt}\n\n${textArea.value}`;
    const chatURL = `https://chat.openai.com/?prompt=${encodeURIComponent(message)}`;
    window.open(chatURL, "_blank");
  };
}
</script>
</html>
